<!DOCTYPE HTML>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<title>Hello Jun</title>
    <script src="src/FlatSystem.js"></script>
    
</head>
<body>
    <div>
        <canvas width="1000" height="300" id="helloworld"></canvas>
    </div>
    <script>
        function $(id){
            return document.getElementById(id);
        }
        var ctx = new FlatSystem($('helloworld').getContext("2d"), 1000, 300);
        ctx.setCalibration(40);
        ctx.onlyQuadrant(1);
        ctx.init();
        
        function Line(x1,y1, x2,y2){
            this.x1 = x1;
            this.y1 = y1;
            
            this.x2 = x2;
            this.y2 = y2;
            this.init();
        }
        Line.prototype = {
            constructor:Line,
            init:function(){
                
                this.a = (this.y1-this.y2)/ (this.x1-this.x2);
                this.b = this.y1 - this.a;
                this.getY = function(x){
                    return a*x + b;
                };
            },
            draw:function(ctx){
                //console.log(this.x1, this.y1, this.x2, this.y2);
                ctx.printLine(this.x1, this.y1, this.x2, this.y2);
            }
        };
    </script>
	<script>
        /**
            line = {
                x1:,y1:,x2:,y2:
            }
            point = {
                x1:, y1:
            }
			
			点是否在线段上
        */
        function isOnLine(line, point){
        
            /**
                y = ax+b;
                首先根据line的起点和终点 计算出a 和 b的值。(线段所在直线的标准公式)
                然后吧point 带入 y = ax + b; 等式成立point在直线 y = ax + b 上。
                然后判断 点x的取值范围如果在线段line的起点x和终点x之间即point在线段line上,否则不在线段line上。

            */
            var x1 = line.x1;
            var y1 = line.y1;
            var x2 = line.x2;
            var y2 = line.y2;
                    //y = ax+b;
			var a = x1-x2 != 0 ? (y1-y2) / (x1-x2) : null;//需要修改斜率不存在的情况
			var b = y1 - a*x1;
			
			
			//console.log(line);
			//console.log(point);
			//console.log(Math.abs(point.y1 -( a * point.x1 + b )) < 1);
			
			if(a == null){//斜率没有  y可以取任值 所以不用判断Y了
				return Math.min(x1, x2) <= point.x1 && Math.max(x1, x2) >= point.x1 && Math.min(y1, y2) <= point.y1 && Math.max(y1, y2) >= point.y1;
			}
				
			
            return  Math.min(x1, x2) <= point.x1 && Math.max(x1, x2) >= point.x1 && (Math.abs(point.y1 -( a * point.x1 + b )) < 1);
			/**
				判断直线是否在点上，误差必须在1px之间，所以要采用绝对值小于1
			*/
        };
        
		/**
			线段是否相交
		*/
        function isLineIntersect(line1, line2){
            var x1 = line1.x1;
            var x2 = line1.x2;
            
            var y1 = line1.y1;
            var y2 = line1.y2;
            
            var a1 = x1-x2 != 0 ? (y1-y2)/(x1-x2) : null;
            var b1 = y1 - a1*x1;
            
            
            //-----------------
            var x3 = line2.x1;
            var x4 = line2.x2;
            
            var y3 = line2.y1;
            var y4 = line2.y2;
            
            var a2 = (x3-x4) != 0 ? (y3-y4)/(x3-x4) : null;
            var b2 = y3 - a2*x3;
            
           // console.log(a1,b1);
            //console.log(a2,b2);
             
            if( a1/a2 != b1 / b2 ){//直线有交点
                console.log("直线有焦点");
                /**
                    y1 = a1*x1 + b1; 
                    y2 = a2*x1 + b2;
                    以上两条直线有焦点，那么焦点坐标p(x,y) 如下表示
                */
      
				var x = -(b2-b1)/(a2-a1);
				var y = a1 * x + b1;
				
				if(a1 == null){
					x = x1;
					y = a2 * x2 + b2;
				}
				
				
				
                //console.log(x, y);
				//判断交点坐标是否在两条线段上
				//console.log(x, y);
				ctx.printPoint(x, y, 5, 5);
                return isOnLine(line1, {x1:x, y1:y}) && isOnLine(line2, {x1:x, y1:y});
                
            }
            
            return false;
        }
        
        
        
        function test(){
            var line = {
                x1:3,y1:100, x2:3,y2:100
            };
            
            var point = {
                x1:2,
                y1:51
            };
            
            return isOnLine(line, point);
        };
        
        function test2(){
            
            // y = 3x + 5;
            var line = {
                x1:30,y1:50, x2:30, y2:30
            };
            
            // y = 0.5x + 10;
            var line2 = {
               x1:20, y1:20, x2:500,y2:20
            };
            /**
			var line2 = {
                x1:20,y1:20, x2:1000, y2:510
            };
            */
			
            new Line(line.x1,line.y1, line.x2, line.y2).draw(ctx);
            new Line(line2.x1,line2.y1, line2.x2, line2.y2).draw(ctx);
            
            return isLineIntersect(line, line2);
        };
        
		
		
		/**
			简单的动画开始
		*/
		
		/**画布*/
		
		function AnimateCtx(ctx){
			this.context = ctx;
			this.elem = [];
			this.setInter = null;
		}
		AnimateCtx.prototype = {
			constructor:AnimateCtx,
			init:function(){
				var _this = this;
				this.setInter = setInterval(function(){
					_this.draw();
				}, 600);
			},
			clear:function(){
				this.context.clear();
			},
			draw:function(){
				this.context.init();
				for(var i=0; i<this.elem.length; i++){
					this.elem[i].draw(this.context);
				}
			},
			stop:function(){
				clearInterval(this.setInter);
			},
			addElem:function(elem){
				this.elem.push(elem);
			}
			
		};
		
		/*小球*/
		function SmallBall(x, y, width, height){
			this.x = x || 10;
			this.y = y || 10;
			this.width = width || 10;
			this.height = height || 10;
			this.g = 0.6;
			this.t = 0;
			this.interval = null;
			//this.init();
		};
		SmallBall.prototype = {
			constructor:SmallBall,
			init:function(){
				
				_this.t++;
				var h = _this.y - 0.5*_this.g*(_this.t*_this.t);
				if( _this.isIntersect(h) ){//撞
					console.log(1);
					//_this.y = this.y;
				}else{
					console.log(2);
					_this.y = h;
				}
					
			},
			draw:function(ctx){
				var _this = this;
				
				ctx.printPoint(this.x, this.y, this.width, this.height);
			},
			move:function(){
				this.x += 10;
			},
			isIntersect:function(h){
				var line1 ={//新线
					x1:this.x, y1:this.y, x2:this.x,y2:h
				};

				var line2 = {
					x1:20, y1:20, x2:500,y2:20
				};
				
				
				new Line(line1.x1,line1.y1, line1.x2, line1.y2).draw(ctx);

				return isLineIntersect(line1, line2);
			}
		};
		
		/*线段*/
		
		
		
		var smallBallMove = new AnimateCtx(ctx);
		var smallBall = new SmallBall(30, 500, 10, 10);
		var line1 = new Line(20, 20, 500, 20);
		smallBallMove.init();
		smallBallMove.addElem(smallBall);
        smallBallMove.addElem(line1);
		
		
		
        
    </script>
</body>
</html>